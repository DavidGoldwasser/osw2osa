# osw2osa
This repo is a sample deployment of a ruby script used to generate OSA files including variable mapping from template OSW and OSA files. This creates the analysis JSON file as well as the zip file containing measures, weather, seed moels,  analysis scripts, and other resources. The bottom of this file shows an example OpenStudio meta-cli call to run the analysis files generated by this script.

- Repository File Structure
    - analysis_scripts
        - This contains an exmaple worker initialization script that installs a custom version of the `openstudio-standards` gem for an analysis.
    - measures
        - Currently this contains a measure to merge a `FloorspaceJS` file into an OpenStudio model. This will be moved to another public repository soon.
        - You would generally use this for single purpose measures that don't exist in another repository and that you don't think will be useful outside of the current project you are setting up.
    - files
        - This contains files that are be used by measures when an OSW or OSA is run. This includes `geojson` and `FloorspaceJS` json files, but may also include any file needed by a measure that isn't already contained within the measure.
    - run (only on local checkout)
        - after you run 'osw_2_osa.rb' this directory will be generated and populated with analysis JSON files and an analysis zip file. These are what are required by the OpenStudio meta-CLI to run an analysis.
    - seeds
        - Seed models that will be used by one or more of the template OSW files and the resulting OSA files.
    - template_osa_files
        - The template OSA files are used for their output variables, objective functions, algorithm settings, and their server scripts. 
        - If the template OSW has defined a seed model and weather file, it will be used in place of what is in the template OSA. 
        - The template OSA should have an empty `workflow` heading under the problem. That will be populated by `osw_2_osa` based on the template OSW and the variable logic in the script.
        - Current templates use design of experiments algorithm (DOE) and SingleRun, but other algorithms can be added.
    - variable_mappping (not used yet)
        - The intent of this is to story custom variable mapping in one or more CSV files and remove this from the script. THe goal is that the script can be generic with custom work being done in the OSW, OSA, and these CSV files. An argument related to a heading in these CSV files can be used by the script.
    - weather
        - Contains weather files that are used by OSW, OSA, or by measures such as the `ChangeBuildingLocaiton` which requires additional EPW, DDY, and STAT files.
    - workflows
        - This contains OSW files that can be run on their own, or used with `osw_2_osa.rb` to setup one or multiple OSA files.
        - bar_typical
        - blend_typical (this is not ready for use with script)
        - floorspace_typical
        - osm_typical (does not exist, will import osm with stub space types and run create_typical measure)
    - osw_2_osa.rb
- Additional public repositories need to be checked out to setup the example analysis projects using `osw_2_osa.rb`. (I may use gem install at some point to get sample measures). These repositories contain most of the measured used by the workflow. The paths in OSW assume these repositories are checked out next to the osw2osa repository.
    - https://github.com/NREL/openstudio-model-articulation-gem/tree/develop
    - https://github.com/NREL/openstudio-common-measures-gem/tree/develop
    - https://github.com/urbanopt/urbanopt-geojson-gem/tree/develop
    - https://github.com/macumber/openstudio-vA3C/tree/master
- Script Arguments
    - ARGV[0] json file is generated unless false. Default value is true.
    - ARGV[1] zip file is generated unless false. Default value is true.
    - ARGV[2] variable set name. Default value is `generic`
    - ARGV[3] parent directory name for source osw (can also be picked based on analysis name in ARGV[3]). Default varies based on variable set.
    - ARG[4] file name for template osa. Default value is `osa_template_doe`.
- Testing
    - Tested using develop checkout of source repositories as of 12/26 using OpenStudio 2.9.0. Tested local OSW runs, and OpenStudio Server based OSA runs.
- Future code development tasks
    - Move variable mapping into csv instead of script, with the intent of minimizing customizaiton rqquired by user to `osw_2_osa.rb`.
    - Update to use 2.9.0 version of measure and test
    - add configuration to adjust local path to checkout of other repos, unless I instead use rake and bundle to install gems here with gemspec file to define branch.
    - Once measure are updated, including results that record climate zone, add that as output to tempalte OSA
    - get script to work better with `runner.workflow.FindPath` instead of havng to alter it in the script

Run Individual Workflow using CLI using 
<br>`openstudio run --workflow /path/to/workflow.osw`. 
<br>To run measure only for testing use 
<br>`openstudio run --measures_only --workflow /path/to/workflow.osw`

Below is a sample command line call to run `osw_2_osa.rb`. The script does use OpenStudio runner methods so it is necessary for your system ruby to be able `require openstudio`. In this example the template OSW and OSA are not passed in, so it will be selected based on the variable set`bar_study_1`.
<br>`ruby true true bar_study_1`

Run OSA files generated by `osw_2_osa.rb` using the OpenStudio meta CLI using code similar to 
<br>`openstudio_meta run_analysis --debug --verbose --ruby-lib-path="/Applications/OpenStudio-2.9.0/ParametricAnalysisTool.app/Contents/Resources/ruby" "osw_2_osa_pv_bool.json" "http://already_running_os_server_url:8080/" -a doe`
